<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Kubernetes with kOps and Terraform - Manan’s Blog</title>
<meta name="description" content="Learn how to use kOps with Terraform and automate your Kubernetes cluster provisioning.">


  <meta name="author" content="Manan Jadhav">
  
  <meta property="article:author" content="Manan Jadhav">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Manan's Blog">
<meta property="og:title" content="Kubernetes with kOps and Terraform">
<meta property="og:url" content="https://mananjadhav.xyz/kubernetes/devops/2023/04/24/kubernetes-with-kops-and-terraform.html">


  <meta property="og:description" content="Learn how to use kOps with Terraform and automate your Kubernetes cluster provisioning.">







  <meta property="article:published_time" content="2023-04-24T00:00:00+00:00">






<link rel="canonical" href="https://mananjadhav.xyz/kubernetes/devops/2023/04/24/kubernetes-with-kops-and-terraform.html">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Manan Jadhav",
      "url": "https://mananjadhav.xyz/"
    
  }
</script>







<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Manan's Blog Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          Manan's Blog
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/all_posts/">All Posts</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="https://avatars.githubusercontent.com/u/2637884?v=4" alt="Manan Jadhav" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Manan Jadhav</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>JavaScript Developer @ <a href="https://codegem.app">CodeGem</a><br /> Flight Sim Enthusiast <br /> Generalist</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Kitchener, Ontario, Canada</span>
        </li>
      

      
        
          
            <li><a href="https://www.linkedin.com/in/jadhavmanan/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span></a></li>
          
        
          
            <li><a href="https://github.com/manan-jadhav" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Kubernetes with kOps and Terraform">
    <meta itemprop="description" content="Learn how to use kOps with Terraform and automate your Kubernetes cluster provisioning.">
    <meta itemprop="datePublished" content="2023-04-24T00:00:00+00:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Kubernetes with kOps and Terraform
</h1>
          

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-calendar-alt" aria-hidden="true"></i>
        
        <time datetime="2023-04-24T00:00:00+00:00">April 24, 2023</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          4 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
        <p>Recently, at CodeGem we migrated our infrastructure from AWS ECS (Elastic Container Service) to our own Kubernetes cluster. Why we made that change is a post of its own, but a quick TL;DR would be:</p>

<ul>
  <li>We needed scheduling capabilites - like K8s CronJobs - but ECS did not natively provide without adding dependency on another AWS Service.</li>
  <li>There wasn’t a clear path about how to run DB migration scripts before each deploy</li>
  <li>We did not have a great experience with rolling updates on ECS.</li>
  <li>I don’t like to have dependencies to services from a specific cloud provider (AWS in this case), for multitude of reasons, the biggest one of which is the dependency it involves on proprietary software &amp; tools.</li>
</ul>

<p><em>(A few of these might be on me as I’m not an ECS power user :P)</em></p>

<div class="align-center" style="width: 400px">
<div style="width:100%;height:0;padding-bottom:56%;position:relative;"><iframe src="https://giphy.com/embed/jnhXd7KT8UTk5WIgiV" width="100%" height="100%" style="position:absolute" frameborder="0" class="giphy-embed" allowfullscreen=""></iframe></div><p><a href="https://giphy.com/gifs/minions-minions-2-rise-of-gru-jnhXd7KT8UTk5WIgiV">via GIPHY</a></p>
</div>

<h2 id="kops---kubernetes-operations">kOps - Kubernetes Operations</h2>

<p>Website / Docs: <a href="https://kops.sigs.k8s.io/cli/kops/">https://kops.sigs.k8s.io/cli/kops/</a></p>

<blockquote>
  <p>kOps is Kubernetes Operations.</p>

  <p>kOps is the easiest way to get a production grade Kubernetes cluster up and running. We like to think of it as kubectl for clusters.</p>
</blockquote>

<p>I’ve worked in the past with kOps and it really helped me maintain my infrastructure as code. I used kOps export files instead of relying on the CLI interface. What I did was:</p>

<ul>
  <li>When creating clusters, use <code class="language-plaintext highlighter-rouge">--dry-run</code> and <code class="language-plaintext highlighter-rouge">--output</code> options to generate YAML config file for the cluster
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kops create cluster <span class="se">\</span>
  <span class="c"># Your kops create cluster options go here</span>
  <span class="c"># --OPTION=VALUE</span>
  <span class="nt">--output</span> yaml <span class="se">\</span>
  <span class="nt">--dry-run</span> <span class="o">&gt;</span> my_cluster.yaml
</code></pre></div>    </div>
  </li>
  <li>Generated YAML file was checked in version control (no it does not contain secrets)</li>
  <li>If I needed to change anything in the cluster, I would edit the YAML file, and do the following commands to update kOps’ state:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kops replace <span class="nt">-f</span> my_cluster.yaml
kops update <span class="c"># verify the changes are what you expected</span>
kops update <span class="nt">--yes</span>
kops rolling-update <span class="nt">--yes</span> <span class="c"># If needed</span>
</code></pre></div>    </div>
  </li>
</ul>

<p>The above approach is a bit different from the default way to use kOps which involves using <code class="language-plaintext highlighter-rouge">kops edit cluster</code>, <code class="language-plaintext highlighter-rouge">kops edit ig nodes</code> and other commands to make the changes, without keeping track of them in version control via the YAML file.</p>

<p>The YAML file helps with making sure you can re-create the cluster if need be, without missing any important add-on or change.</p>

<p class="notice">
<strong>Example</strong> <br />
In our case, one such thing was <code>httpPutResponseHopLimit</code> for our instances to be increased above the default value of 1. <br />
<br />

If we had made the change via <code>kops edit ig nodes</code>, I would for sure have forgotten that this was an important step, and if I ever had to re-create the cluster, I would definitely have a hard time recalling!
</p>

<h2 id="terraform">Terraform</h2>

<p>Website / Docs: <a href="https://www.terraform.io/">https://www.terraform.io/</a></p>

<blockquote>
  <p>Terraform Cloud enables infrastructure automation for provisioning, compliance, and management of any cloud, datacenter, and service.</p>
</blockquote>

<p>Terraform is a very popular infrastructure-as-a-code tool, and you can use it to automate setting up essentially any type of infrastructure on any major cloud provider. It is also able to reconcile cloud resources which have deviated from their desired state (deleted or updated manually by mistake).</p>

<p>But hold on, doesn’t kOps do the same for your infrastructure needed for your K8s cluster? kOps does do that, but I’ve found that terraform does a better job most of the time when it comes to managing cloud resources.</p>

<p class="notice">
<strong>Example</strong> <br />
When I previously used kOps, it had a hard time reconciling infrastructure differences, incase I had deleted / modified something on AWS directly.
</p>

<p>Terraform also provides many additional utilities and scripting abilities which aren’t there with kOps just yet.</p>

<p>What’s great though, is that kOps allows <strong>exporting</strong> a Terraform config instead of creating / managing cloud resources itself, and this my fellow technologist, is the gold mine!</p>

<div class="align-center" style="width: 400px">
<div style="width:100%;height:0;padding-bottom:75%;position:relative;"><iframe src="https://giphy.com/embed/pPzjpxJXa0pna" width="100%" height="100%" style="position:absolute" frameborder="0" class="giphy-embed" allowfullscreen=""></iframe></div><p><a href="https://giphy.com/gifs/pPzjpxJXa0pna">via GIPHY</a></p>
</div>

<h2 id="kops-x-terraform">kOps X Terraform</h2>

<p><img src="https://i.kym-cdn.com/entries/icons/original/000/037/334/Kowalski.jpg" alt="Kowalski, Analysis!" class="align-center" /></p>

<p>To use Terraform for managing your cloud resources, add the <code class="language-plaintext highlighter-rouge">--out</code> and <code class="language-plaintext highlighter-rouge">--target</code> options to your <code class="language-plaintext highlighter-rouge">kops update cluster</code> command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kops update cluster <span class="nt">--out</span><span class="o">=</span>kops-terraform <span class="nt">--target</span><span class="o">=</span>terraform
</code></pre></div></div>

<p>This will generate terraform config files under the <code class="language-plaintext highlighter-rouge">kops-terraform</code> directory. You can change into that directory and run <code class="language-plaintext highlighter-rouge">terraform apply</code>, and terraform will create the cloud resources for you.</p>

<p>For our use case, however, we needed some extra resources to be created, such as a VPC Peering Connection, some extra IAM Roles and Policies. These resources were used during runtime - by pods running in k8s cluster to use AWS APIs.</p>

<p>In order to achieve that, I created a new terraform module, and imported the terraform generated by kOps as a module. Here’s how you can do that:</p>

<div class="language-terraform highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># terraform.tf</span>

<span class="k">module</span> <span class="s2">"kops"</span> <span class="p">{</span>
  <span class="nx">source</span> <span class="p">=</span> <span class="s2">"./kops-terraform"</span>
<span class="p">}</span>


<span class="k">resource</span> <span class="s2">"aws_iam_role"</span> <span class="s2">"my_custom_role"</span> <span class="p">{</span>
  <span class="nx">inline_policy</span> <span class="p">{</span>
    <span class="nx">name</span> <span class="p">=</span> <span class="s2">"my_role_policy"</span>
    <span class="nx">policy</span> <span class="p">=</span> <span class="nx">jsonencode</span><span class="p">({</span>
      <span class="s2">"Version"</span><span class="err">:</span> <span class="s2">"2012-10-17"</span><span class="p">,</span>
      <span class="s2">"Statement"</span><span class="err">:</span> <span class="p">[</span>
        <span class="s2">"Your IAM Role Policy Statements"</span>
      <span class="p">]</span>
    <span class="p">})</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>When I run <code class="language-plaintext highlighter-rouge">terraform apply</code> in my directory, it creates the resources needed by kOps, AND, my other resources too.</p>

<h3 id="handling-cluster-updates-with-terraform">Handling cluster updates with Terraform</h3>

<p>Handling kOps cluster updates is a bit different when using kOps with Terraform vs when using kOps only. When using terraform, you need to run these commands after updating your cluster YAML file:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kops replace <span class="nt">-f</span> my_cluster.yaml

<span class="c"># Check that the change is what you expected</span>
kops update 

<span class="c"># Generate terraform config, this will overwrite the kops-terraform directory</span>
kops update <span class="nt">--yes</span> <span class="nt">--out</span><span class="o">=</span>kops-terraform <span class="nt">--target</span><span class="o">=</span>terraform 

<span class="c"># Update cloud resources</span>
terraform apply
</code></pre></div></div>

<section class="notice notice-warning">
<p><b>Note: Don't modify terraform files!</b></p>
<p>kOps will update terraform files written in the output directory, you must consider kOps as the single source of truth and not modify the generated terraform files manually.</p>

<p>This is why I suggest including the kOps terraform files as module and adding any additional cloud resource configuration in your own terraform files.</p>
</section>

<h2 id="bonus-using-terraform-output-in-helmfile">Bonus: Using Terraform output in Helmfile</h2>

<p>Terraform offers an option to output the terraform output as a JSON which you can load in your Helmfile setup. This is very useful if you want to provide resource identifiers which are usually dynamically generated when the cloud resources are created.</p>

<p>To generate the terraform output (advisable to gitignore this):</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>terraform output <span class="nt">-json</span> <span class="o">&gt;</span> terraform.json
</code></pre></div></div>

<p>And then in your <code class="language-plaintext highlighter-rouge">helmfile.yaml</code>, you can do:</p>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">values</span><span class="o">:</span>
    <span class="o">-</span> <span class="n">terraform</span><span class="o">:</span> <span class="p">{{</span>  <span class="n">readFile</span> <span class="s">"./terraform.json"</span> <span class="p">}}</span>
</code></pre></div></div>
<div class="align-center" style="width: 400px">
<div style="width:100%;height:0;padding-bottom:125%;position:relative;"><iframe src="https://giphy.com/embed/l2Sq5GffrCyUMEXjW" width="100%" height="100%" style="position:absolute" frameborder="0" class="giphy-embed" allowfullscreen=""></iframe></div><p><a href="https://giphy.com/gifs/arg-l2Sq5GffrCyUMEXjW">via GIPHY</a></p>
</div>

        
      </section>

      <footer class="page__meta">
        
        


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2023-04-24T00:00:00+00:00">April 24, 2023</time></p>


      </footer>

      

      
  <nav class="pagination">
    
      <a href="/2023/04/22/hello-world.html" class="pagination--pager" title="Hello World!
">Previous</a>
    
    
      <a href="#" class="pagination--pager disabled">Next</a>
    
  </nav>

    </div>

    
      <div class="page__comments">
  
  
      <h4 class="page__comments-title">Comments</h4>
      <section id="disqus_thread"></section>
    
</div>

    
  </article>

  
  
</div>

    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2023 Manan Jadhav. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>







    
  <script>
    var disqus_config = function () {
      this.page.url = "https://mananjadhav.xyz/kubernetes/devops/2023/04/24/kubernetes-with-kops-and-terraform.html";  /* Replace PAGE_URL with your page's canonical URL variable */
      this.page.identifier = "/kubernetes/devops/2023/04/24/kubernetes-with-kops-and-terraform"; /* Replace PAGE_IDENTIFIER with your page's unique identifier variable */
    };
    (function() { /* DON'T EDIT BELOW THIS LINE */
      var d = document, s = d.createElement('script');
      s.src = 'https://mananjadhav-xyz.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


  





  </body>
</html>
